Implement the ticket: tasks/backlog/T-0801-search-service-accept-query-context-v1.md

Rules:
- Read and follow AGENTS.md (SSOT).
- Stay within scope: ONLY modify services/search-service/**.
- You MAY also update docs/RUNBOOK.md and scripts/test.sh if needed.
- Do NOT touch infra/**, contracts/**, db/**, services/query-service/**, services/ranking-service/**, or any apps/**.

Context:
- Search Service exists (Spring Boot, port 8080) and already supports POST /search with hybrid retrieval (lexical +
  vector + RRF) and optional Ranking Service integration (T0702).
- Query Service already provides QueryContext v1; in this ticket, Search Service must ACCEPT QueryContext v1 as input.
  Search Service MUST NOT call Query Service in this ticket.

Required Behavior:
1) API input
- Update POST /search to accept QueryContext v1 input.
- Keep backward compatibility if the ticket allows it:
  - Accept either:
    A) { "query_context": <QueryContextV1>, "options": {...} }
    OR
    B) the old format { "query": { "raw": "..." }, "options": {...} }
- If both are present, prefer query_context.

2) Query selection rule (MVP)
- Determine final query string in this order:
  - query_context.query.canonical
  - else query_context.query.normalized
  - else query_context.query.raw
- If final query string is missing/blank -> 400 JSON error:
  { "error": { "code": "bad_request", "message": "..." }, "trace_id": "...", "request_id": "..." }

3) IDs propagation (trace/request)
- Use x-trace-id / x-request-id headers if present.
- Else, if query_context has trace_id / request_id, use them.
- Else generate UUIDs.
- Ensure the response always returns trace_id/request_id.

4) Retrieval hints integration (MVP)
- If query_context.retrieval_hints exists:
  - If retrieval_hints.top_k is present, use it as the internal topK for lexical/vector retrieval (cap to a safe range,
    e.g. 10..500).
  - If retrieval_hints.time_budget_ms is present, apply as timeout budget for OpenSearch calls (cap to e.g. 50..1000ms).
  - If retrieval_hints.strategy indicates bm25-only / hybrid:
    - For bm25-only: disable vector retrieval even if options.enableVector=true
    - For hybrid: allow vector retrieval (subject to options.enableVector)
  - If retrieval_hints.boost exists (e.g. title/authors weights), apply it in lexical multi_match fields using ^ weights
    where possible.
    Example: "title_ko^2.0", "authors.name_ko^1.2" etc.
- If hints are missing, default to existing behavior.

5) Output shape
- Keep existing SearchResponse shape (trace_id, request_id, took_ms, strategy, hits...).
- Keep debug fields (lex_rank, vec_rank, rrf_score, ranking_score, ranking_applied) as currently implemented.

6) Tests (must pass on clean checkout)
- Add/Update unit tests so:
  cd services/search-service && ./gradlew test
  passes without OpenSearch running.
- Add at least:
  - /search accepts query_context and uses canonical/normalized/raw fallback correctly.
  - trace_id/request_id rules: header overrides QC; QC used when headers missing.
  - invalid input returns 400 with error body.

Validation (run and report results):
- cd services/search-service && ./gradlew test
- (Optional manual) Start OpenSearch: ./scripts/local_up.sh
- Start Search Service: cd services/search-service && ./gradlew bootRun
- Call /search with query_context payload and confirm hits >= 1:
  curl -s -XPOST "http://localhost:8080/search" -H "Content-Type: application/json" -d '<payload>'

Implementation Notes:
- Keep code small and readable.
- Prefer adding DTOs for QueryContext inside search-service (do not edit contracts/**).
- Do not over-engineer; MVP acceptance is enough.
- If you must update docs/RUNBOOK.md, keep it short.
