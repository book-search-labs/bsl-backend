# B-0XXX — Flyway Adoption: Baseline an Existing DB (already created by `scripts/ingest/sql`) and Move to a Single `db/migration` Source

## Context

We already executed SQL under `./scripts/ingest/sql`, so the database contains many tables and data.
If we run Flyway using `./db/migration` in this state, Flyway will treat the schema as “not migrated yet” (no schema history table) and try to apply `V1..`, which will likely conflict with existing tables and fail.

Long-term, we want to move the ingest SQL into `./db/migration` so **one Flyway execution** can manage the schema consistently.

## Problem Statement

* DB cannot be reset (tables/data must be preserved).
* Need a safe way to start using Flyway with `./db/migration` **on top of an existing schema**.
* Current SQL sources are split (`scripts/ingest/sql` vs `db/migration`), which makes reproducibility and operations hard. We need a path to unify them.

## Goals

1. **Adopt Flyway without dropping existing tables/data** by baselining the current schema.
2. Standardize Flyway configuration/commands so `./db/migration` is the single source of truth going forward.
3. Define a migration strategy to eventually move/convert `./scripts/ingest/sql` into Flyway-managed migrations.

## Non-Goals

* Dropping/cleaning/resetting the existing database.

---

## Scope

### A) Baseline existing schema (no data loss)

* Ensure `flyway_schema_history` is created and baseline is recorded (e.g., baseline at version `11` or the agreed current version).
* Provide the exact Flyway CLI command(s) for:

  * `info`
  * `baseline`
  * `migrate`
  * (optional) `repair`
* Document the recommended baseline version strategy:

  * “Treat current DB as already at V<N>” and only manage **V<N+1>+** going forward.

### B) Unify SQL sources over time

* Decide how to handle `./scripts/ingest/sql`:

  * Option 1: Keep as legacy/manual and only create new changes in `db/migration` (recommended initially).
  * Option 2: Move/port ingest SQL into `db/migration` (requires careful conflict avoidance).
* Define rules for new migrations (V12+):

  * Must be written based on the **current live schema**.
  * Avoid breaking existing data.
  * Prefer safe patterns (e.g., `IF NOT EXISTS`, additive migrations).

### C) Developer documentation

* Add a short README section (or dedicated doc) explaining:

  * Why baseline is needed
  * How to run Flyway in dev/stage
  * Common failure modes (table already exists, FK reference errors)
  * How to verify schema version (`flyway info` + DB checks)

---

## Acceptance Criteria / DoD

* Running `flyway info` shows the schema is baselined to the chosen version and does **not** list `V1..V<N>` as runnable migrations.
* Running `flyway migrate` does not attempt to re-create existing tables and completes successfully when no new migrations exist.
* A documented, repeatable procedure exists for:

  * Setting up Flyway on an already-initialized DB
  * Adding future migrations (V<N+1>+)
  * (Optional) Repairing failed entries
* Clear guidance exists for the eventual move from `scripts/ingest/sql` to `db/migration`.

---

## Notes / Reference Commands (example)

```bash
flyway \
  -url="jdbc:mysql://localhost:3306/bsl?useSSL=false&allowPublicKeyRetrieval=true" \
  -user=bsl -password=bsl \
  -locations=filesystem:db/migration \
  info

flyway \
  -url="jdbc:mysql://localhost:3306/bsl?useSSL=false&allowPublicKeyRetrieval=true" \
  -user=bsl -password=bsl \
  -locations=filesystem:db/migration \
  -baselineVersion=<N> \
  baseline

flyway \
  -url="jdbc:mysql://localhost:3306/bsl?useSSL=false&allowPublicKeyRetrieval=true" \
  -user=bsl -password=bsl \
  -locations=filesystem:db/migration \
  migrate
```
