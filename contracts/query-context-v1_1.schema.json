{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "query-context-v1_1.schema.json",
  "title": "QueryContextV1_1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "meta",
    "query",
    "detected",
    "slots",
    "understanding",
    "spell",
    "rewrite",
    "retrievalHints",
    "features",
    "policy",
    "executionTrace",
    "debug"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "schemaVersion",
        "traceId",
        "requestId",
        "timestampMs",
        "tenantId",
        "locale",
        "timezone",
        "client",
        "user",
        "compat"
      ],
      "properties": {
        "schemaVersion": { "type": "string" },
        "traceId": { "type": "string" },
        "requestId": { "type": "string" },
        "spanId": { "type": ["string", "null"] },
        "timestampMs": { "type": "integer" },
        "tenantId": { "type": "string" },
        "locale": { "type": "string" },
        "timezone": { "type": "string" },
        "client": { "type": ["object", "null"], "additionalProperties": true },
        "user": { "type": ["object", "null"], "additionalProperties": true },
        "compat": {
          "type": "object",
          "additionalProperties": false,
          "required": ["minSearchRequestVersion", "minRerankRequestVersion"],
          "properties": {
            "minSearchRequestVersion": { "type": "string" },
            "minRerankRequestVersion": { "type": "string" }
          }
        }
      }
    },
    "query": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "raw",
        "nfkc",
        "norm",
        "nospace",
        "final",
        "finalSource",
        "canonicalKey",
        "tokens",
        "normalized"
      ],
      "properties": {
        "raw": { "type": "string" },
        "nfkc": { "type": "string" },
        "norm": { "type": "string" },
        "nospace": { "type": "string" },
        "final": { "type": "string" },
        "finalSource": { "type": "string" },
        "canonicalKey": { "type": "string" },
        "tokens": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["t", "pos", "type", "protected"],
            "properties": {
              "t": { "type": "string" },
              "pos": { "type": "integer" },
              "type": { "type": "string" },
              "protected": { "type": "boolean" }
            }
          }
        },
        "protectedSpans": { "type": "array", "items": { "type": "string" } },
        "normalized": {
          "type": "object",
          "additionalProperties": false,
          "required": ["rulesApplied"],
          "properties": {
            "rulesApplied": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    },
    "detected": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "isIsbn", "hasVolume", "lang", "isMixed"],
      "properties": {
        "mode": { "type": "string" },
        "isIsbn": { "type": "boolean" },
        "hasVolume": { "type": "boolean" },
        "lang": {
          "type": "object",
          "additionalProperties": false,
          "required": ["primary", "confidence"],
          "properties": {
            "primary": { "type": "string" },
            "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "isMixed": { "type": "boolean" }
      }
    },
    "slots": {
      "type": "object",
      "additionalProperties": false,
      "required": ["isbn", "volume", "edition", "set", "chosung"],
      "properties": {
        "isbn": { "type": ["string", "null"] },
        "volume": { "type": ["integer", "null"], "minimum": 1 },
        "edition": { "type": "array", "items": { "type": "string" } },
        "set": {
          "type": "object",
          "additionalProperties": false,
          "required": ["value", "confidence", "source"],
          "properties": {
            "value": { "type": "boolean" },
            "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
            "source": { "type": "string" }
          }
        },
        "chosung": {
          "type": "object",
          "additionalProperties": false,
          "required": ["value", "confidence", "source"],
          "properties": {
            "value": { "type": "boolean" },
            "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
            "source": { "type": "string" }
          }
        }
      }
    },
    "understanding": {
      "type": "object",
      "additionalProperties": false,
      "required": ["intent", "confidence", "method", "entities", "constraints"],
      "properties": {
        "intent": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "method": { "type": "string" },
        "entities": { "type": "object", "additionalProperties": true },
        "constraints": { "type": "object", "additionalProperties": true }
      }
    },
    "spell": {
      "type": "object",
      "additionalProperties": false,
      "required": ["applied", "original", "corrected", "method", "confidence"],
      "properties": {
        "applied": { "type": "boolean" },
        "original": { "type": "string" },
        "corrected": { "type": "string" },
        "method": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "rewrite": {
      "type": "object",
      "additionalProperties": false,
      "required": ["applied", "rewritten", "method", "notes"],
      "properties": {
        "applied": { "type": "boolean" },
        "rewritten": { "type": "string" },
        "method": { "type": "string" },
        "notes": { "type": "string" }
      }
    },
    "retrievalHints": {
      "type": "object",
      "additionalProperties": true,
      "required": ["planId", "queryTextSource", "lexical", "vector", "rerank", "filters", "fallbackPolicy", "executionHint", "guardrails"],
      "properties": {
        "planId": { "type": "string" },
        "queryTextSource": { "type": "string" },
        "lexical": { "type": "object", "additionalProperties": true },
        "vector": { "type": "object", "additionalProperties": true },
        "rerank": { "type": "object", "additionalProperties": true },
        "filters": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
        "fallbackPolicy": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
        "executionHint": { "type": "object", "additionalProperties": true },
        "guardrails": { "type": "object", "additionalProperties": true }
      }
    },
    "features": { "type": "object", "additionalProperties": true },
    "policy": { "type": "object", "additionalProperties": true },
    "executionTrace": { "type": "object", "additionalProperties": true },
    "debug": { "type": "object", "additionalProperties": true }
  }
}
